<html>
<head>
  <title>ToDo List</title>
  <script type="text/javascript" src="/assets/jquery/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="/assets/datatables/css/jquery.dataTables.min.css">
  <script type="text/javascript" charset="utf8" src="/assets/datatables/js/jquery.dataTables.js"></script> 

</head>
<body>
  <input id="listId" type="hidden">
  <div class="container">
    <div class="row">
      <div class="col-sm-12" style="background: grey;">
        <h1 style="color:white; padding-left: 5pt;">ToDo List</h1>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="col-sm-12">
        <table id="table_id" class="display">
          <thead>
            <th>Name</th>
            <th>State</th> 
            <th>CreatedAt</th> 
            <th>Actions</th> 
          </thead>
        </table>
      </div>
    </div>
    <div clas="row">
      <div class="col-sm-12">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addUpdateList">
          Add List
        </button>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <hr>
      </div>
    </div>
  </div>
  
  <footer id="sticky-footer" class="py-4 bg-dark text-white-50">
    <div class="container text-center">
      <small>Copyright &copy; Milos Milojevic</small>
    </div>
  </footer>
  <div id="addUpdateList" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add/Update List</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="list-name" class="col-form-label">Name:</label>
              <input type="text" class="form-control" id="list-name">
            </div>
            <div class="form-group">
              <label for="state-text" class="col-form-label">State:</label>
              <input type="text" class="form-control" id="state-text">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btAddList" type="button" class="btn btn-primary">Save changes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div id="deleteList" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete List</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this list?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button id="btDelete" onclick="confirmDelete()" type="button" class="btn btn-primary">Delete</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready( function () {
      $.ajax({
      url: "http://localhost:3000/list",
      type: "post", 
      dataType: "json",
      success: function(res) {
        console.log(res); 
        $('#table_id').DataTable({
        data : res,
        columns: [
           { data: 'name' },
           { data: 'state' },
           //{ data: 'created_at' },
           {
              'data': 'created_at',
              'searchable': false,
              'sortable': false,
              'render': function(data, type, row ){
                  var date = new Date(row.created_at);
                  return date.toDateString();
              }
           },
           { 
              'data': 'id',
              'searchable': false,
              'sortable': false,
              'render': function(data, type, row ){
                  return '<a href="/list/'+row.id+'"> View </a> | <a onclick="Delete('+row.id+')" href="javascript:void(0);">Delete </a> |<a onclick="Update('+row.id+',\''+row.name+'\',\''+row.state+'\')'+'" href="javascript:void(0);"> Update </a>';
              }

            }
            
        ]
        });
      },
      error: function(xhr) {
        console.log(xhr);
      }
    });
    
   
    $( "#btAddList" ).click(function() {
      if ($('#list-name').val() ==='' || $('#state-text').val() ===''){
          alert("Name and State must have value!");
      }
      else{
        if ( $("#listId").val() > 0){
            $.ajax({
              url: "http://localhost:3000/update/"+$("#listId").val(),
              type: "put", 
              dataType: "json",
              data: {'id':$("#listId").val(), 'name' : $('#list-name').val(), 'state' : $('#state-text').val()},
              success: function(res) {
                console.log(res); 
                location.reload();
              },
              error: function(xhr) {
                console.log(xhr);
              }
            });
        }
        else{
            $.ajax({
              url: "http://localhost:3000/add",
              type: "post", 
              dataType: "json",
              data: {'name' : $('#list-name').val(), 'state' : $('#state-text').val()},
              success: function(res) {
                //console.log(res); 
                location.reload();
              },
              error: function(xhr) {
                //console.log(xhr);
              }
          });
      }
    }
    });
 
  });

  function confirmDelete(){
      var listId = $("#listId").val();
      $.ajax({
        url: "http://localhost:3000/delete/"+listId,
        type: "delete", 
        dataType: "json",
        success: function(res) {
          console.log(res); 
          location.reload();
        },
        error: function(xhr) {
          console.log(xhr);
        }
      });
  };

  function Delete(id){
    $("#listId").val(id);
    $("#deleteList").modal();
  }

  function Update(id, name, state){
    $("#listId").val(id);
    $("#addUpdateList").modal();
    $("#list-name").val(name);
    $("#state-text").val(state);
  }

  </script>
</body>
</html>